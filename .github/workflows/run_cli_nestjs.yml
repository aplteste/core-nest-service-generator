name: Run CLI NestJS

on:
  workflow_dispatch:
    inputs:
      trigger_event:
        description: "Backstage trigger event name"
        required: true
        type: string
      execution_id:
        description: "Execution identifier"
        required: true
        type: string
      repository_name:
        description: "Target repository name"
        required: true
        type: string
      components:
        description: "JSON string containing component configurations"
        required: true
        default: "{}"
        type: string

jobs:
  backstage-tag:
    name: tag_${{ github.event.inputs.trigger_event }}_${{ github.event.inputs.execution_id }}
    runs-on: ubuntu-latest
    timeout-minutes: 1

    steps:
      - name: Correlation marker
        run: |
          echo "trigger_event=${{ github.event.inputs.trigger_event }}"
          echo "execution_id=${{ github.event.inputs.execution_id }}"
          echo "repository_name=${{ github.event.inputs.repository_name }}"

  debug-params:
    needs: backstage-tag
    name: Run CLI
    runs-on: ubuntu-latest
    timeout-minutes: 1

    steps:
      - name: Print Raw Input
        run: |
          echo "Received raw JSON:"
          echo '${{ github.event.inputs.components }}'

      - name: Parse and Print Specific Values
        run: |
          timeout 60s bash -c '
            REPOSITORY_NAME="${{ github.event.inputs.repository_name }}"
            EXECUTION_ID="${{ github.event.inputs.execution_id }}"
            COMPONENTS="${{ github.event.inputs.components }}"

            echo "Repository Name: $REPOSITORY_NAME"
            echo "Execution ID: $EXECUTION_ID"

            REST_STATUS=$(echo "$COMPONENTS" | jq -r ".rest.enabled")
            GQL_STATUS=$(echo "$COMPONENTS" | jq -r ".graphql.enabled")
            PG_HEALTH=$(echo "$COMPONENTS" | jq -r ".postgres.healthCheck")
            REDIS_HEALTH=$(echo "$COMPONENTS" | jq -r ".redis.healthCheck")

            echo "---------------------------------------"
            echo "Rest Enabled: $REST_STATUS"
            echo "GraphQL Enabled: $GQL_STATUS"
            echo "Postgres HealthCheck: $PG_HEALTH"
            echo "Redis HealthCheck: $REDIS_HEALTH"
            echo "---------------------------------------"
          '

      - name: Conditional Step Example
        if: ${{ fromJson(github.event.inputs.components).graphql.enabled == true }}
        run: echo "GraphQL is enabled. Performing GraphQL specific tasks..."
